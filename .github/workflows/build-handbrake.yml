name: Build HandBrakeCLI on Amazon Linux 2023

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Amazon Linux Docker image
        run: |
          docker build -f Dockerfile.amazonlinux -t handbrake-al2023:latest .

      - name: Run container to build HandBrakeCLI
        run: |
          # Run container in detached mode so we can copy files out later
          CONTAINER_NAME=handbrake-build
          docker rm -f $CONTAINER_NAME || true
          docker run --name $CONTAINER_NAME -d handbrake-al2023:latest
          # Wait for the build to finish. The entrypoint script exits when done.
          docker wait $CONTAINER_NAME

      - name: Copy HandBrakeCLI binary from container
        run: |
          CONTAINER_NAME=handbrake-build
          mkdir -p output
          docker cp $CONTAINER_NAME:/usr/local/bin/HandBrakeCLI output/HandBrakeCLI || true
          docker rm -f $CONTAINER_NAME || true
          ls -la output || true

      - name: Upload HandBrakeCLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: HandBrakeCLI
          path: output/HandBrakeCLI
